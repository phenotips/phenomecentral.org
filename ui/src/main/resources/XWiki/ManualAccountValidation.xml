<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>XWiki</web>
  <name>ManualAccountValidation</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1413312915000</creationDate>
  <parent>XWiki.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1413312915000</date>
  <contentUpdateDate>1413312915000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
#if ("$!{request.xwikiname}" != '' &amp;&amp; "$!{request.action}" != '')
  $response.setContentType("application/json")
  #set ($userDoc = $xwiki.getDocument(${request.xwikiname}))
  #set ($user = $userDoc.getObject('XWiki.XWikiUsers'))
  #set ($firstName = $user.getValue('first_name'))
  #set ($lastName = $user.getValue('last_name'))
  #set ($realName = "$!{firstName} $!{lastName}")
  #set ($email = $user.getProperty('email').getValue())

  #if ("$!{email}" != '')

    #set ($adminGroupName = 'XWiki.SignUpAdmins')
    #set ($adminsGroupDoc = $xwiki.getDocument($adminGroupName))
    #set ($adminObjects = $adminsGroupDoc.getObjects('XWiki.XWikiGroups'))
    #set($cc = '')
    #set($mainAdminEmail = '')
    #set($mainAdminName = '')
    #set($first = true)
    #foreach ($adminObj in $adminObjects)
      #set($v = $adminObj.getValue('member'))
      #if ($!v != '')
        #set($adminDoc = $xwiki.getDocument($v))
        #set($adminUser = $adminDoc.getObject('XWiki.XWikiUsers'))
        #set($adminEmail = $adminUser.getValue('email'))
        #if($first)
          #set($first = $adminUser.getValue('first_name'))
          #set($last = $adminUser.getValue('last_name'))
          #set($mainAdminName = "$first $last")
          #set($mainAdminEmail = $adminEmail)
          #set($first = false)
          #set($cc = $mainAdminEmail)
        #else
          #set($cc = "${cc}, ${adminEmail}")
        #end
      #end
    #end

    #if ("$!{request.action}" == 'accept')
      #set($emailTemplate = 'XWiki.ManualAccountValidation')
    #elseif("$!{request.action}" == 'reject')
      #set($emailTemplate = 'XWiki.AccountRejectionTemplate')
    #end

    #set ($emailStatus = $xwiki.mailsender.sendMessageFromTemplate('PhenomeCentral &lt;noreply@phenomecentral.org&gt;', $email, $cc, $NULL, '', $emailTemplate, {
       "userRealName": $realName.trim(),
       "userName": $userDoc.name,
       "adminName": $mainAdminName,
       "adminEmail": $mainAdminEmail,
       "platformName": "PhenomeCentral",
       "loginURL": $xwiki.getDocument($services.model.resolveDocument('', 'default', $doc.documentReference.extractReference('WIKI'))).getExternalURL()}))

  #else
    #set ($emailStatus = 0)
  #end

  #if ("$!{request.action}" == 'accept')
    $user.set('active', 1)
  #elseif("$!{request.action}" == 'reject')
    $userDoc.delete()
  #end

  #if ($emailStatus == 0)
    #if ("$!{request.action}" == 'accept')
      $userDoc.save()
    #end
true
  #else
false
  #end
#end
{{/velocity}}
</content>
  <object>
    <name>XWiki.ManualAccountValidation</name>
    <number>0</number>
    <className>XWiki.Mail</className>
    <guid>bf97bf71-ec20-42b0-8577-21068d41d00c</guid>
    <class>
      <name>XWiki.Mail</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <html>
        <disabled>0</disabled>
        <name>html</name>
        <number>4</number>
        <prettyName>HTML</prettyName>
        <rows>15</rows>
        <size>80</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </html>
      <language>
        <disabled>0</disabled>
        <name>language</name>
        <number>2</number>
        <prettyName>Language</prettyName>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </language>
      <subject>
        <disabled>0</disabled>
        <name>subject</name>
        <number>1</number>
        <prettyName>Subject</prettyName>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </subject>
      <text>
        <disabled>0</disabled>
        <name>text</name>
        <number>3</number>
        <prettyName>Text</prettyName>
        <rows>15</rows>
        <size>80</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </text>
    </class>
    <property>
      <html>&lt;p&gt;Dear ${userRealName},&lt;/p&gt;
&lt;p&gt;An account has been created for you on ${platformName}. If you forgot your password, please visit &lt;a href="https://phenomecentral.org/XWiki/ResetPassword"&gt;https://phenomecentral.org/XWiki/ResetPassword&lt;/a&gt; and enter your username ${userName}. Please do not hesitate to contact us if you experience any difficulties with your account.&lt;/p&gt;
&lt;p&gt;You can view your closest matches immediately after entering your patient into ${platformName}! Simply create the patient record, click Save and View Summary and scroll down to Similar Cases Available in the Database. You will be able to find similar cases in ${platformName}, DECIPHER and GeneMatcher based on phenotype and candidate genes.&lt;/p&gt;
&lt;p&gt;For more detailed instructions, please visit: &lt;a href="http://monarch-initiative.blogspot.ca/2015/01/how-to-annotate-patients-phenotypic.html"&gt;http://monarch-initiative.blogspot.ca/2015/01/how-to-annotate-patients-phenotypic.html&lt;/a&gt;. You can contact me at ${adminEmail} if you want tips on how to effectively enter your patients into the database.&lt;/p&gt;
&lt;p&gt;If you are submitting a case for the Clinical Genetics journal, please follow the instructions listed at &lt;a href="https://phenomecentral.org/PhenomeCentral/Instructions+for+Submitting+to+Clinical+Genetics"&gt;https://phenomecentral.org/PhenomeCentral/Instructions+for+Submitting+to+Clinical+Genetics&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;We look forward to collaborating with you through ${platformName}.&lt;/p&gt;
&lt;p&gt;Sincerely,&lt;br&gt;
${adminName}&lt;br&gt;
${platformName} Team&lt;/p&gt;
&lt;br&gt;
&lt;span style="color: darkgray; font-size: small"&gt;
&lt;p style="display: none"&gt;====================================&lt;/p&gt;
&lt;p&gt;&lt;b&gt;TERMS AND CONDITIONS OF REGISTRATION&lt;/b&gt;&lt;/p&gt;
&lt;p&gt;1. I confirm that I am a doctor, clinical geneticist or scientist working with patients affected by rare disorders.&lt;/p&gt;
&lt;p&gt;2. ${platformName} provides data in good faith as a research tool, but without verifying the accuracy, clinical validity or utility of the data. ${platformName} makes no warranty, express or implied, nor assumes any legal liability or responsibility for any purpose for which the data are used.&lt;/p&gt;
&lt;p&gt;3. The user certifies that no attempt to identify individual patients will be undertaken.&lt;/p&gt;
&lt;p&gt;4. Prior to using ${platformName} data in a publication, the user will contact the owner of the matching dataset to assess the integrity of the match and if validated will offer appropriate agreed recognition of their contribution, which may include co-authorhship if the magnitude of the contribution warrants it to at least on representative from the project/participating centre (possibly the member who submitted the patient data).&lt;/p&gt;
&lt;p&gt;5. If ${platformName} enables a research publication, the authors must acknowledge ${platformName} using the following wording: “This study makes use of data shared the ${platformName} repository. Funding for ${platformName} provided by Genome Canada and the Canadian Institute of Health Research (CIHR).&lt;/p&gt;
&lt;/span&gt;</html>
    </property>
    <property>
      <language/>
    </property>
    <property>
      <subject>Your account at PhenomeCentral has been approved</subject>
    </property>
    <property>
      <text>Dear ${userRealName},

An account has been created for you on ${platformName}. If you forgot your password, please visit https://phenomecentral.org/XWiki/ResetPassword and enter your username ${userName}. Please do not hesitate to contact us if you experience any difficulties with your account.

You can view your closest matches immediately after entering your patient into ${platformName}! Simply create the patient record, click Save and View Summary and scroll down to Similar Cases Available in the Database. You will be able to find similar cases in ${platformName}, DECIPHER and GeneMatcher based on phenotype and candidate genes.
 
For more detailed instructions, please visit: http://monarch-initiative.blogspot.ca/2015/01/how-to-annotate-patients-phenotypic.html. You can contact me at ${adminEmail} if you want tips on how to effectively enter your patients into the database.

If you are submitting a case for the Clinical Genetics journal, please follow the instructions listed at https://phenomecentral.org/PhenomeCentral/Instructions+for+Submitting+to+Clinical+Genetics
 
We look forward to collaborating with you through ${platformName}.
 
Sincerely,

${adminName}
${platformName} Team


====================================

TERMS AND CONDITIONS OF REGISTRATION

1. I confirm that I am a doctor, clinical geneticist or scientist working with patients affected
by rare disorders.
2. ${platformName} provides data in good faith as a research tool, but without verifying the
accuracy, clinical validity or utility of the data. ${platformName} makes no warranty,
express or implied, nor assumes any legal liability or responsibility for any purpose for
which the data are used.
3. The user certifies that no attempt to identify individual patients will be undertaken.
4. Prior to using ${platformName} data in a publication, the user will contact the owner of
the matching dataset to assess the integrity of the match and if validated will offer
appropriate agreed recognition of their contribution, which may include co-authorhship if
the magnitude of the contribution warrants it to at least on representative from the
project/participating centre (possibly the member who submitted the patient data).
5. If ${platformName} enables a research publication, the authors must acknowledge
${platformName} using the following wording: “This study makes use of data shared
though the ${platformName} repository. Funding for ${platformName} was provided by
Genome Canada and the Canadian Institute of Health Research (CIHR).</text>
    </property>
  </object>
</xwikidoc>
