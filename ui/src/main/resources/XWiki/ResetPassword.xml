<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>XWiki</web>
  <name>ResetPassword</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1404836679000</creationDate>
  <parent>Main.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1393588480000</date>
  <contentUpdateDate>1393588480000</contentUpdateDate>
  <version>1.1</version>
  <title>$services.localization.render('xe.admin.passwordReset.title')</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
$xwiki.ssx.use('data.WebHome')##
$xwiki.ssx.use('PhenomeCentral.logo')##
$xwiki.ssx.use('PhenomeCentral.login')##
#**
This page starts the password reset procedure. It works according to the next algorithm:
1. Display a form requesting the username
2. When receiving the username via form submission, generate a random verification string which is stored (as a hash) inside a ResetPasswordRequestClass object attached to the user's profile page. If no such object exists, it is created, but an existing object will be reused, meaning that at most one password reset request can be active at a moment.
3. Send an email to the address configured in the user's profile, containing a link to the second step of the password reset procedure.

URL parameters:

u = user account sent in the form
*###
##
##
## The name of the class used for storing password reset verification data.
#set ($verifClass = 'XWiki.ResetPasswordRequestClass')
#set ($userName = "$!request.get('u')")
#if ($userName == '')## First step, display the form requesting the username
  {{translation key="xe.admin.passwordReset.instructions"/}}

  {{html}}
  &lt;form method="post" action="" class="xformInline"&gt;
  #if ($hasAdmin)
  &lt;div&gt;
  &lt;input type="checkbox" id="s" name="s" value="1" #if ($request.s == '1')checked="checked" #end/&gt; &lt;label for="s"&gt;Send initial activation email&lt;/label&gt;
  &lt;/div&gt;
  #end
  &lt;div&gt;
  &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
  &lt;label for="u"&gt;$services.localization.render('xe.admin.passwordReset.username.label')&lt;/label&gt; &lt;input type="text" id="u" name="u"/&gt; &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="$services.localization.render('xe.admin.passwordReset.submit')" class="button"/&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;/form&gt;
  {{/html}}
#else## Second step, generate the verification string, store it, and send the email
  ## TODO: Once the usernames are not bound to the XWiki space, revisit this code
  #if ($userName.indexOf('.') != -1)
    #set ($userDoc = $xwiki.getDocumentAsAuthor(${userName}))
  #else
    #set ($userDoc = $xwiki.getDocumentAsAuthor("XWiki.${userName}"))
  #end
  ## Check if the user exists and has a valid email address configured in his profile
  #set ($userObj = '')
  #set ($userObj = $userDoc.getObject('XWiki.XWikiUsers'))
  #if (!$userObj)

    {{warning}}$services.localization.render('xe.admin.passwordReset.error.noUser', ["//${escapetool.xml($userName)}//"]){{/warning}}

  #elseif ($userDoc.getObject('XWiki.LDAPProfileClass'))

    {{warning}}$services.localization.render('xe.admin.passwordReset.error.ldapUser', ["//${escapetool.xml($userName)}//"]){{/warning}}

  #else
    #set ($userEmail = $userObj.getProperty('email').value)
    #if ("$!userEmail" == '')

      {{error}}{{translation key="xe.admin.passwordReset.error.noEmail"/}}{{/error}}

    #else
      ## Find the object that will hold the verification string
      #set ($verifObj = '')
      #set ($verifObj = $userDoc.getObject($verifClass, true))
      ## Generate a random string
      #set ($verifStr = $util.generateRandomString(30))
      ## If the class is correctly configured, the string should automatically be stored as a hash
      #set ($discard = $verifObj.set('verification', $verifStr))
      #set ($discard = $userDoc.saveAsAuthor($services.localization.render('xe.admin.passwordReset.versionComment'), true))
      ## Compose the verification URL
      #set ($passwordResetURL = $xwiki.getDocument('XWiki.ResetPasswordComplete').getExternalURL('view', "u=${userName}&amp;v=${verifStr}"))
      ## Send an email; the variables will be retrieved from the velocity context
      #if ($hasAdmin &amp;&amp; $request.s == '1')
        #set ($mailDocument = 'XWiki.SetPasswordMailContent')
      #else
        #set ($mailDocument = 'XWiki.ResetPasswordMailContent')
      #end
      #set ($mailResult = $xwiki.mailsender.sendMessageFromTemplate($xwiki.getXWikiPreference('admin_email', "no-reply@${request.serverName}"), $userEmail, $NULL, $NULL, $xcontext.language, $mailDocument, {}))
      #if ($mailResult == 0)

        {{info}}$services.localization.render('xe.admin.passwordReset.emailSent', ["${escapetool.h}#$userDoc.display('email', $userObj)${escapetool.h}#"]){{/info}}

      #else

        {{error}}{{translation key="xe.admin.passwordReset.error.emailFailed"/}}{{/error}}

      #end
    #end
  #end
  [[{{translation key="xe.admin.passwordReset.error.retry"/}}&gt;&gt;$doc.fullName#if ($request.s == '1')||queryString="s=1"#end]] | [[{{translation key="xe.admin.passwordReset.error.recoverUsername"/}}&gt;&gt;ForgotUsername]] | [[{{translation key="xe.admin.passwordReset.login"/}}&gt;&gt;path:$xwiki.getURL('XWiki.XWikiLogin', 'login')]]
#end
## Clear private variables, so that they cannot be accessed from the rest of the page (comments, panels...)
#set ($verifStr = '')
#set ($passwordResetURL = '')
{{/velocity}}</content>
  <object>
    <name>XWiki.ResetPassword</name>
    <number>0</number>
    <className>XWiki.XWikiRights</className>
    <guid>8a0e8611-2818-4181-a8e9-1d1623ac3e77</guid>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <property>
      <allow>0</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>edit</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
  <object>
    <name>XWiki.ResetPassword</name>
    <number>1</number>
    <className>XWiki.XWikiRights</className>
    <guid>bb00007c-00dd-4423-9b7b-b87896c947fb</guid>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <property>
      <allow>0</allow>
    </property>
    <property>
      <groups>xwiki:XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>edit</levels>
    </property>
  </object>
  <object>
    <name>XWiki.ResetPassword</name>
    <number>2</number>
    <className>XWiki.XWikiRights</className>
    <guid>06daec64-228b-4da1-b7e6-b59d9624c866</guid>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>view</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
</xwikidoc>
